<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ប្រព័ន្ធកត់ត្រាម៉ោងសម្រាក - BioBreak System</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Kantumruy Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: "Kantumruy Pro", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        /* Notification Slide In - Smooth Entrance */
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in-right {
            animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        /* Glassmorphism Styles */
        .glass-panel {
            background: rgba(10, 40, 30, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(16, 185, 129, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .glass-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(52, 211, 153, 0.3);
            color: white;
        }
        .glass-input:focus {
            border-color: #10b981;
            outline: none;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        .neon-text {
            text-shadow: 0 0 10px rgba(52, 211, 153, 0.5);
        }

        /* Red Alert Animation */
        @keyframes redPulse {
            0% { border-color: #ef4444; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { border-color: #b91c1c; box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { border-color: #ef4444; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .overtime-alert {
            animation: redPulse 2s infinite;
            border: 2px solid #ef4444 !important;
        }

        /* Scrollbar Customization */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.3);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.6);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left-color: #10b981;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Full Screen Overlay Animation */
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-zoom-in {
            animation: zoomIn 0.2s ease-out forwards;
        }
        
        /* Selected Card Animation in Modal */
        .selected-card {
            border-color: #34d399 !important; /* Emerald 400 */
            box-shadow: 0 0 0 4px rgba(52, 211, 153, 0.3) !important;
            transform: scale(1.02);
            background-color: rgba(6, 78, 59, 0.6) !important; /* Emerald 900/60 */
        }
        
        /* Clickable Card Hover Effect */
        .clickable-card {
            cursor: pointer;
        }
        .clickable-card:active {
            transform: scale(0.98);
        }
        
        /* Mobile Tab Styles */
        .mobile-tab-active {
            color: #34d399;
            border-top: 2px solid #34d399;
        }
        .mobile-tab-inactive {
            color: #94a3b8;
            border-top: 2px solid transparent;
        }
    </style>
</head>
<body class="min-h-screen bg-[#051a14] bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-emerald-900/40 via-[#051a14] to-black text-slate-100 selection:bg-emerald-500/30 selection:text-emerald-200 overflow-x-hidden">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- INTERNAL ICON COMPONENTS ---
        const SvgIcon = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Clock = (props) => (<SvgIcon {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></SvgIcon>);
        const Coffee = (props) => (<SvgIcon {...props}><path d="M17 8h1a4 4 0 1 1 0 8h-1" /><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z" /><line x1="6" x2="6" y1="2" y2="4" /><line x1="10" x2="10" y1="2" y2="4" /><line x1="14" x2="14" y1="2" y2="4" /></SvgIcon>);
        const LogIn = (props) => (<SvgIcon {...props}><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" /><polyline points="10 17 15 12 10 7" /><line x1="15" x2="3" y1="12" y2="12" /></SvgIcon>);
        const LogOut = (props) => (<SvgIcon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></SvgIcon>);
        const User = (props) => (<SvgIcon {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></SvgIcon>);
        const History = (props) => (<SvgIcon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M12 7v5l4 2" /></SvgIcon>);
        const Trash2 = (props) => (<SvgIcon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></SvgIcon>);
        const Calendar = (props) => (<SvgIcon {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></SvgIcon>);
        const Plus = (props) => (<SvgIcon {...props}><path d="M5 12h14" /><path d="M12 5v14" /></SvgIcon>);
        const Timer = (props) => (<SvgIcon {...props}><line x1="10" x2="14" y1="2" y2="2" /><line x1="12" x2="15" y1="14" y2="11" /><circle cx="12" cy="14" r="8" /></SvgIcon>);
        const Zap = (props) => (<SvgIcon {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></SvgIcon>);
        const Settings = (props) => (<SvgIcon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></SvgIcon>);
        const Cloud = (props) => (<SvgIcon {...props}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19" /><path d="M12 13.5V5" /><path d="m16 9-4-4-4 4" /></SvgIcon>);
        const CheckCircle = (props) => (<SvgIcon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></SvgIcon>);
        const CloudOff = (props) => (<SvgIcon {...props}><path d="m2 2 20 20" /><path d="M5.782 5.782A7 7 0 0 0 9 19h8.5a4.5 4.5 0 0 0 1.307-.193" /><path d="M21.532 16.5A4.5 4.5 0 0 0 17.5 10c-.374 0-.733.04-1.082.113" /><path d="M17.5 10V5" /></SvgIcon>);
        const SheetIcon = (props) => (<SvgIcon {...props}><path d="M3 3v18h18V3H3zm16 16H5V5h14v14zM7 7h10v2H7zm0 4h10v2H7zm0 4h7v2H7z"/></SvgIcon>);
        const RefreshCw = (props) => (<SvgIcon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></SvgIcon>);
        const Search = (props) => (<SvgIcon {...props}><circle cx="11" cy="11" r="8" /><line x1="21" x2="16.65" y1="21" y2="16.65" /></SvgIcon>);
        const X = (props) => (<SvgIcon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></SvgIcon>);
        const ChevronDown = (props) => (<SvgIcon {...props}><path d="m6 9 6 6 6-6"/></SvgIcon>);
        const AlertTriangle = (props) => (<SvgIcon {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" x2="12" y1="9" y2="13" /><line x1="12" x2="12.01" y1="17" y2="17" /></SvgIcon>);

        // --- NOTIFICATION COMPONENT ---
        const NotificationToast = ({ note, onDismiss, onAction, activeBreaks }) => (
            <div 
                className="mb-4 bg-red-900/95 border-l-4 border-red-500 text-white p-4 rounded-lg shadow-2xl flex items-center justify-between animate-slide-in-right hover:bg-red-800 cursor-pointer transition-all w-80 backdrop-blur-md z-[10000]"
                onClick={() => onAction(activeBreaks.find(b => b.id === note.breakId))}
            >
                <div className="flex items-start gap-3">
                    <div className="bg-red-500/20 p-2 rounded-full">
                        <AlertTriangle size={24} className="text-red-400" />
                    </div>
                    <div>
                        <h4 className="font-bold text-lg leading-tight">{note.name}</h4>
                        <p className="text-sm text-red-200 mt-1">
                            លើសកំណត់ <span className="font-bold bg-red-500/20 px-1 rounded">{note.overdueMinutes} នាទី</span>
                        </p>
                        <p className="text-[10px] text-red-300/70 mt-1">ចុចទីនេះដើម្បីចូលវិញ</p>
                    </div>
                </div>
                <button 
                    onClick={(e) => { e.stopPropagation(); onDismiss(note.id); }}
                    className="text-red-300 hover:text-white p-1 rounded-full hover:bg-white/10"
                >
                    <X size={18} />
                </button>
            </div>
        );

        // --- MAIN APP COMPONENT ---

        function App() {
            const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbynTNPQlq_Dx4DvyXuYJ54ry2XxHtm6kmW75O9paAnAWobObZADYQQNir6eSYm9s9b_/exec";
            
            const playNotificationSound = () => {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, ctx.currentTime); 
                    osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.5);
                    const gain = ctx.createGain();
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.5);
                } catch (e) {
                    console.error("Audio play failed", e);
                }
            };

            // State
            const [nameInput, setNameInput] = useState('');
            const [activeBreaks, setActiveBreaks] = useState([]); 
            const [records, setRecords] = useState([]); 
            const [allRecords, setAllRecords] = useState([]); 
            const [currentTime, setCurrentTime] = useState(new Date());
            const [scriptUrl, setScriptUrl] = useState(DEFAULT_SCRIPT_URL);
            const [showSettings, setShowSettings] = useState(false);
            const [syncStatus, setSyncStatus] = useState('offline');
            const [showFullActiveList, setShowFullActiveList] = useState(false);
            const [searchActiveQuery, setSearchActiveQuery] = useState('');
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [selectedIndex, setSelectedIndex] = useState(-1);
            
            // Mobile Specific State
            const [mobileTab, setMobileTab] = useState('active'); // 'active' or 'history'
            
            // Notifications State
            const [notifications, setNotifications] = useState([]); 
            
            const inputRef = useRef(null);
            const searchRef = useRef(null);
            const lastLocalUpdate = useRef(0);
            const lastNotificationTime = useRef({}); 
            
            const activeBreaksRef = useRef(activeBreaks);
            useEffect(() => { activeBreaksRef.current = activeBreaks; }, [activeBreaks]);

            // AUTO-FOCUS ON MOUNT
            useEffect(() => {
                if (inputRef.current) {
                    inputRef.current.focus();
                }
            }, []);

            // OVERTIME CHECKER (Every 1 second)
            useEffect(() => {
                const checkTimer = setInterval(() => {
                    const now = Date.now();
                    const currentActiveBreaks = activeBreaksRef.current;
                    const newAlerts = [];

                    currentActiveBreaks.forEach((breakItem, index) => {
                        const start = new Date(breakItem.startTime);
                        if (isNaN(start.getTime())) return;

                        const diffMs = now - start.getTime();
                        const durationMinutes = Math.floor(diffMs / 60000);
                        const LIMIT_MINUTES = 15;

                        if (durationMinutes > LIMIT_MINUTES) {
                            // Check visibility (Top 6) on desktop or general list
                            // On mobile, we might want alerts too, but let's stick to the logic provided:
                            // If visible in top 6 (desktop), no toast. 
                            // For mobile, all are visible in list, but let's keep logic consistent.
                            const isVisibleOnMainUI = index < 6;

                            if (!isVisibleOnMainUI) {
                                const overdue = durationMinutes - LIMIT_MINUTES;
                                const lastNotified = lastNotificationTime.current[breakItem.id] || 0;
                                
                                if (now - lastNotified > 300000) {
                                    newAlerts.push({
                                        id: breakItem.id, 
                                        breakId: breakItem.id,
                                        name: breakItem.name,
                                        overdueMinutes: overdue,
                                        expiresAt: now + 20000 
                                    });
                                    lastNotificationTime.current[breakItem.id] = now;
                                }
                            }
                        }
                    });

                    setNotifications(prev => {
                        const stillActive = prev.filter(n => now < n.expiresAt);
                        if (newAlerts.length === 0 && stillActive.length === prev.length) {
                            return prev;
                        }
                        if (newAlerts.length > 0) playNotificationSound();
                        return [...newAlerts, ...stillActive];
                    });

                }, 1000); 

                return () => clearInterval(checkTimer);
            }, []); 

            const closeNotification = (id) => {
                setNotifications(prev => prev.filter(n => n.id !== id));
            };

            // KEYBOARD SHORTCUTS
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.altKey && e.key === '1') {
                        e.preventDefault();
                        setShowFullActiveList(prev => !prev);
                    }
                    if (e.key === 'Escape') {
                        if (showFullActiveList) setShowFullActiveList(false);
                        if (showSettings) setShowSettings(false);
                        setShowSuggestions(false);
                        setSelectedIndex(-1);
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [showFullActiveList, showSettings]);

            // Auto-focus search input when Full List opens
            useEffect(() => {
                if (showFullActiveList && searchRef.current) {
                    setTimeout(() => searchRef.current.focus(), 100);
                }
            }, [showFullActiveList]);

            // Load Config & Data
            useEffect(() => {
                const savedUrl = localStorage.getItem('googleScriptUrl');
                const urlToUse = savedUrl || DEFAULT_SCRIPT_URL;
                setScriptUrl(urlToUse);

                if (urlToUse) {
                    fetchData(urlToUse);
                } else {
                    setShowSettings(true);
                }
            }, []);

            // Auto-Refresh
            useEffect(() => {
                if (!scriptUrl) return;
                const interval = setInterval(() => {
                    if (Date.now() - lastLocalUpdate.current > 10000) {
                        fetchData(scriptUrl, true);
                    }
                }, 5000); 
                return () => clearInterval(interval);
            }, [scriptUrl]);

            // Save local
            useEffect(() => {
                localStorage.setItem('localActiveBreaks', JSON.stringify(activeBreaks));
            }, [activeBreaks]);

            // Reset selection index
            useEffect(() => {
                setSelectedIndex(-1);
            }, [nameInput, showSuggestions]);

            const handleSaveSettings = () => {
                if (!scriptUrl.trim()) return;
                localStorage.setItem('googleScriptUrl', scriptUrl);
                setShowSettings(false);
                fetchData(scriptUrl);
            };

            const parseSheetDate = (dateStr, timeStr) => {
                if (!dateStr || !timeStr) return null;
                try {
                    const dateObj = new Date(dateStr);
                    if (isNaN(dateObj.getTime())) return null; 

                    let hours = 0;
                    let minutes = 0;

                    if (typeof timeStr === 'string' && timeStr.includes('T')) {
                         const timeObj = new Date(timeStr);
                         if (!isNaN(timeObj.getTime())) {
                             hours = timeObj.getHours();
                             minutes = timeObj.getMinutes();
                         }
                    } else {
                         const timeObj = new Date(`1/1/2000 ${timeStr}`);
                         if (!isNaN(timeObj.getTime())) {
                             hours = timeObj.getHours();
                             minutes = timeObj.getMinutes();
                         }
                    }

                    dateObj.setHours(hours);
                    dateObj.setMinutes(minutes);
                    dateObj.setSeconds(0);
                    
                    return dateObj;
                } catch (e) {
                    return null;
                }
            };

            const isToday = (dateVal) => {
                if (!dateVal) return false;
                const today = new Date();
                
                let d;
                if (typeof dateVal === 'string' && dateVal.includes('-')) {
                    const parts = dateVal.split('-');
                    if (parts.length === 3 && parts[1].length === 3) {
                        const day = parseInt(parts[0], 10);
                        const monthStr = parts[1];
                        const year = parseInt(parts[2], 10);
                        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                        const month = months.indexOf(monthStr);
                        
                        if (month !== -1) {
                             return day === today.getDate() &&
                                    month === today.getMonth() &&
                                    year === today.getFullYear();
                        }
                    }
                    d = new Date(dateVal);
                } else {
                    d = new Date(dateVal);
                }
                
                if (isNaN(d.getTime())) return false;

                return d.getDate() === today.getDate() &&
                       d.getMonth() === today.getMonth() &&
                       d.getFullYear() === today.getFullYear();
            };

            const fetchData = async (url, isBackground = false) => {
                const fetchStart = Date.now(); 

                if (isBackground && Date.now() - lastLocalUpdate.current < 10000) return;

                if (!isBackground) setSyncStatus('syncing');
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (lastLocalUpdate.current > fetchStart) {
                        if (!isBackground) setSyncStatus('idle');
                        return;
                    }

                    if (Array.isArray(data)) {
                        const parsedData = data.map(d => {
                            let start = parseSheetDate(d.date, d.startTime);
                            let end = d.endTime ? parseSheetDate(d.date, d.endTime) : null;
                            
                            if (!start || isNaN(start.getTime())) start = new Date(); 
                            
                            if (start && end && end < start) {
                                end.setDate(end.getDate() + 1);
                            }

                            let durationMinutes = 0;
                            if (start && end) {
                                const diffMs = end - start;
                                durationMinutes = Math.floor(diffMs / 60000);
                            }

                            return {
                                ...d,
                                startTime: start,
                                endTime: end,
                                durationMinutes: durationMinutes
                            };
                        });

                        const active = parsedData.filter(d => !d.endTime);
                        const historyAll = parsedData.filter(d => d.endTime);
                        const historyToday = historyAll.filter(d => isToday(d.date));

                        setActiveBreaks(active);
                        setAllRecords(historyAll);
                        setRecords(historyToday);
                        
                        if (!isBackground) {
                            setSyncStatus('success');
                            setTimeout(() => setSyncStatus('idle'), 3000);
                        }
                    }
                } catch (error) {
                    console.error("Fetch Error:", error);
                    if (!isBackground) setSyncStatus('error');
                }
            };

            const sendToSheet = async (payload) => {
                if (!scriptUrl) return;
                setSyncStatus('syncing');
                
                try {
                    await fetch(scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });

                    setSyncStatus('success');
                    setTimeout(() => setSyncStatus('idle'), 3000);
                    
                } catch (error) {
                    console.error("Sync Error:", error);
                    setSyncStatus('error');
                    alert("មិនអាចរក្សាទុកទៅ Google Sheet បានទេ!");
                }
            };

            const formatDateForSheet = (date) => {
                const day = date.getDate().toString().padStart(2, '0');
                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            };

            // --- SMART SUGGESTIONS LOGIC ---
            const suggestions = useMemo(() => {
                const nameMap = new Map();

                allRecords.forEach(r => {
                    const lowerName = r.name.toLowerCase();
                    if (!nameMap.has(lowerName)) {
                        nameMap.set(lowerName, {
                            originalName: r.name,
                            countToday: 0,
                            durationToday: 0,
                            lastTimestamp: 0
                        });
                    }
                    const entry = nameMap.get(lowerName);
                    const rTime = r.endTime ? r.endTime.getTime() : 0;
                    if (rTime > entry.lastTimestamp) {
                        entry.lastTimestamp = rTime;
                        entry.originalName = r.name; 
                    }
                    if (isToday(r.date)) {
                        entry.countToday += 1;
                        let mins = r.durationMinutes;
                        if (!mins && typeof r.duration === 'string') {
                            mins = parseInt(r.duration) || 0;
                        }
                        entry.durationToday += (mins || 0);
                    }
                });

                const activeNames = activeBreaks.map(b => b.name.toLowerCase());

                const suggestionList = Array.from(nameMap.values()).map(entry => ({
                    name: entry.originalName,
                    count: entry.countToday,
                    totalDuration: entry.durationToday,
                    isToday: entry.countToday > 0,
                    lastTimestamp: entry.lastTimestamp
                }));

                const filtered = suggestionList.filter(item => 
                    !activeNames.includes(item.name.toLowerCase()) && 
                    item.name.toLowerCase().includes(nameInput.toLowerCase())
                );

                return filtered.sort((a, b) => {
                    if (a.isToday && !b.isToday) return -1;
                    if (!a.isToday && b.isToday) return 1;
                    return b.lastTimestamp - a.lastTimestamp; 
                });

            }, [allRecords, activeBreaks, nameInput]);

            const handleInputKeyDown = (e) => {
                if (!showSuggestions || suggestions.length === 0) return; 

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    setSelectedIndex(prev => (prev < suggestions.length - 1 ? prev + 1 : prev));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    setSelectedIndex(prev => (prev > 0 ? prev - 1 : -1));
                } else if (e.key === 'Enter') {
                    if (selectedIndex >= 0) {
                        e.preventDefault();
                        selectSuggestion(suggestions[selectedIndex].name);
                    }
                }
            };

            const handleStartBreak = (e, nameOverride = null) => {
                if (e) e.preventDefault();
                const name = nameOverride || nameInput.trim();
                
                if (!name) return;
                if (!scriptUrl) { alert("សូមបញ្ចូល Google Script URL ជាមុនសិន!"); setShowSettings(true); return; }

                if (activeBreaks.some(b => b.name.toLowerCase() === name.toLowerCase())) {
                    alert(`ឈ្មោះ "${name}" កំពុងសម្រាករួចហើយ!`);
                    return;
                }

                // 1. UPDATE LOCAL STATE IMMEDIATELY (OPTIMISTIC UI)
                const now = new Date();
                const newBreak = {
                    id: Date.now(),
                    name: name,
                    startTime: now,
                    date: formatDateForSheet(now)
                };

                setActiveBreaks(prev => [newBreak, ...prev]);
                setNameInput('');
                setShowSuggestions(false);
                setSelectedIndex(-1);
                inputRef.current?.focus();

                lastLocalUpdate.current = Date.now();

                sendToSheet({ 
                    ...newBreak, 
                    startTime: formatTime(now),
                    action: 'start' 
                });
            };

            const selectSuggestion = (name) => {
                handleStartBreak(null, name);
            };

            const handleEndBreak = (breakItem) => {
                if (!scriptUrl) return;
                
                closeNotification(breakItem.id);

                const now = new Date();
                const start = new Date(breakItem.startTime);
                const diffMs = now - start;
                const durationMinutes = Math.floor(diffMs / 60000);

                const completedRecord = {
                    ...breakItem,
                    endTime: now,
                    durationMinutes: durationMinutes
                };

                setActiveBreaks(prev => prev.filter(b => b.id !== breakItem.id));
                setRecords(prev => [completedRecord, ...prev]);
                setAllRecords(prev => [completedRecord, ...prev]);

                lastLocalUpdate.current = Date.now();

                sendToSheet({ 
                    id: breakItem.id, 
                    endTime: formatTime(now), 
                    duration: `${durationMinutes}នាទី`, 
                    action: 'end' 
                });
            };

            const handleDeleteRecord = (recordId) => {
                if (!confirm("តើអ្នកចង់លុបប្រវត្តិមួយនេះមែនទេ?")) return;
                setRecords(prev => prev.filter(r => r.id !== recordId));
                setAllRecords(prev => prev.filter(r => r.id !== recordId));
                lastLocalUpdate.current = Date.now();
                sendToSheet({ id: recordId, action: 'delete' });
            };

            const handleRefresh = () => {
                if (scriptUrl) fetchData(scriptUrl);
            };

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            const formatTime = (date) => {
                if(!date) return "";
                return new Date(date).toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    hour12: true 
                }).replace(" ", "");
            };

            const calculateLiveDurationInfo = (startTime) => {
                const start = new Date(startTime);
                if (isNaN(start.getTime())) return { text: "00:00:00", minutes: 0 };

                const diff = Math.floor((currentTime - start) / 1000);
                const hrs = Math.floor(diff / 3600);
                const mins = Math.floor((diff % 3600) / 60);
                const secs = diff % 60;
                const pad = (num) => num.toString().padStart(2, '0');
                const totalMinutes = Math.floor(diff / 60);
                const text = `${hrs > 0 ? pad(hrs) + ':' : ''}${pad(mins)}:${pad(secs)}`;
                return { text, minutes: totalMinutes };
            };

            const formatTotalMinutes = (minutes) => {
                if (typeof minutes === 'string' && minutes.includes('នាទី')) return minutes;
                if (typeof minutes === 'number') {
                    if (minutes > 500000) return "Error"; 
                    return `${minutes}នាទី`;
                }
                return "--";
            };

            const filteredActiveBreaks = activeBreaks.filter(item => 
                item.name.toLowerCase().includes(searchActiveQuery.toLowerCase())
            );

            return (
                <div className="relative" onClick={() => setShowSuggestions(false)}>
                    
                    {/* NOTIFICATION CONTAINER */}
                    <div className="fixed top-4 right-4 z-[9999] flex flex-col gap-2">
                        {notifications.map(note => (
                            <NotificationToast 
                                key={note.id} 
                                note={note} 
                                onDismiss={closeNotification}
                                onAction={handleEndBreak}
                                activeBreaks={activeBreaks}
                            />
                        ))}
                    </div>

                    {/* --- FULL SCREEN OVERLAY UI (ALT + 1) --- */}
                    {showFullActiveList && (
                        <div className="fixed inset-0 z-[200] bg-[#051a14]/95 backdrop-blur-md flex flex-col animate-zoom-in overflow-hidden">
                            {/* Header */}
                            <div className="flex items-center justify-between p-6 border-b border-emerald-500/20 bg-black/20">
                                <h2 className="text-3xl font-bold text-white flex items-center gap-3">
                                    <Coffee className="text-emerald-400" size={36} />
                                    <span>បុគ្គលិកកំពុងសម្រាកទាំងអស់ ({activeBreaks.length})</span>
                                </h2>
                                <button 
                                    onClick={() => setShowFullActiveList(false)}
                                    className="p-3 bg-white/10 hover:bg-white/20 rounded-full transition text-white"
                                >
                                    <X size={28} />
                                </button>
                            </div>

                            {/* Search Bar */}
                            <div className="p-6 max-w-4xl mx-auto w-full">
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-6 flex items-center pointer-events-none">
                                        <Search className="text-emerald-500/50 group-focus-within:text-emerald-400 transition-colors" size={32} />
                                    </div>
                                    <input
                                        ref={searchRef}
                                        type="text"
                                        value={searchActiveQuery}
                                        onChange={(e) => setSearchActiveQuery(e.target.value)}
                                        placeholder="វាយឈ្មោះដើម្បីស្វែងរក និងចូលវិញ..."
                                        className="w-full pl-20 pr-8 py-6 rounded-2xl glass-input text-2xl font-bold text-white placeholder:text-slate-500 focus:bg-black/60 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 outline-none transition-all duration-300"
                                    />
                                </div>
                            </div>

                            {/* Grid List */}
                            <div className="flex-1 overflow-y-auto p-6 md:p-10">
                                <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                    {filteredActiveBreaks.map((item) => (
                                        <div 
                                            key={item.id} 
                                            onClick={() => handleEndBreak(item)}
                                            className="bg-black/40 border border-emerald-500/30 p-6 rounded-3xl hover:bg-emerald-900/20 hover:border-emerald-400 transition-all duration-300 group shadow-lg clickable-card"
                                        >
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 className="text-2xl font-bold text-white mb-1">{item.name}</h3>
                                                    <div className="flex items-center gap-2 text-emerald-400/80 text-sm font-mono bg-black/30 px-2 py-1 rounded-lg w-fit">
                                                        <Clock size={14} /> {formatTime(item.startTime)}
                                                    </div>
                                                </div>
                                                <div className="bg-emerald-500/10 text-emerald-400 px-3 py-1 rounded-lg font-mono font-bold text-xl border border-emerald-500/20">
                                                    {calculateLiveDurationInfo(item.startTime).text}
                                                </div>
                                            </div>
                                            
                                            <button
                                                className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-emerald-500/30 transition-all flex items-center justify-center gap-2 transform active:scale-95 group-hover:scale-[1.02]"
                                            >
                                                <LogIn size={24} /> ចូលវិញ
                                            </button>
                                        </div>
                                    ))}
                                    {filteredActiveBreaks.length === 0 && (
                                        <div className="col-span-full text-center py-20 text-slate-500 text-xl">
                                            រកមិនឃើញឈ្មោះនេះទេ...
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            <div className="p-4 text-center text-slate-500 text-sm border-t border-white/5">
                                ចុច <span className="px-2 py-1 bg-white/10 rounded font-mono text-white">Esc</span> ដើម្បីបិទ
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-slide-in">
                            <div className="glass-panel w-full max-w-lg p-6 rounded-2xl border border-emerald-500/30">
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                                    <Settings className="text-emerald-400" /> ការកំណត់ Google Sheet API
                                </h2>
                                <p className="text-sm text-slate-400 mb-2">
                                    សូមបញ្ចូល <b>Google Apps Script Web App URL</b> របស់អ្នក។
                                </p>
                                <input 
                                    type="text"
                                    value={scriptUrl}
                                    onChange={(e) => setScriptUrl(e.target.value)}
                                    placeholder='https://script.google.com/macros/s/...'
                                    className="w-full p-3 rounded-xl glass-input mb-6 text-sm"
                                />
                                <div className="flex justify-end gap-3">
                                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-slate-400 hover:text-white transition">បិទ</button>
                                    <button onClick={handleSaveSettings} className="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded-xl font-bold transition">រក្សាទុក</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* DESKTOP UI (Hidden on mobile) */}
                    <div className="hidden md:flex flex-col min-h-screen">
                        {/* Top Navbar */}
                        <nav className="sticky top-0 z-50 glass-panel border-b border-emerald-500/10">
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="bg-emerald-500/20 p-2 rounded-lg text-emerald-400 border border-emerald-500/30 shadow-[0_0_15px_rgba(16,185,129,0.3)]">
                                        <Zap size={20} />
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold text-white tracking-wider neon-text hidden sm:block">
                                            BIO<span className="text-emerald-400">BREAK</span> SHEETS
                                        </h1>
                                        <h1 className="text-lg font-bold text-white tracking-wider neon-text sm:hidden">
                                            BIO<span className="text-emerald-400">BREAK</span>
                                        </h1>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    {/* Sync Status Indicator */}
                                    <button onClick={handleRefresh} title="ចុចដើម្បី Refresh ទិន្នន័យ" className={`flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/5 transition active:scale-95 ${syncStatus === 'success' || syncStatus === 'idle' ? 'bg-emerald-900/20' : 'bg-rose-900/20'}`}>
                                        {syncStatus === 'syncing' && <div className="spinner"></div>}
                                        {(syncStatus === 'success' || syncStatus === 'idle') && <SheetIcon size={16} className="text-emerald-400" />}
                                        {syncStatus === 'error' && <CloudOff size={16} className="text-rose-500" />}
                                        
                                        <span className="text-xs font-medium text-slate-300 hidden sm:inline">
                                            {syncStatus === 'syncing' ? 'Syncing...' : 
                                            syncStatus === 'error' ? 'Error' : 'Auto Sync'}
                                        </span>
                                    </button>

                                    <button onClick={() => setShowSettings(true)} className="p-2 text-slate-400 hover:text-white transition hover:bg-white/10 rounded-lg">
                                        <Settings size={20} />
                                    </button>
                                    
                                    <div className="hidden md:flex flex-col items-end border-l border-emerald-500/20 pl-4">
                                        <span className="text-xs font-bold text-emerald-500/80 uppercase tracking-widest">
                                            {currentTime.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                                        </span>
                                        <span className="text-lg font-bold font-mono text-white leading-none tracking-widest">
                                            {currentTime.toLocaleTimeString('en-US', { hour12: false })}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </nav>

                        <main className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex-1 w-full">
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            {/* Left Panel: Input & Active List */}
                            <div className="lg:col-span-8 space-y-8">
                                
                                {/* Quick Input Card - Added z-30 for stacking fix */}
                                <div className="glass-panel rounded-3xl p-1 relative overflow-visible group z-30">
                                    <div className="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl pointer-events-none"></div>

                                    <div className="p-6 md:p-8 relative z-10">
                                        <div className="flex items-center justify-between mb-6">
                                            <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                                                <Coffee className="text-emerald-400" size={32} />
                                                <span>ចាប់ផ្តើមសម្រាក</span>
                                            </h2>
                                            <div className="bg-emerald-500/20 text-emerald-300 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide border border-emerald-500/20">
                                                New Entry
                                            </div>
                                        </div>

                                        <form onSubmit={handleStartBreak} className="relative group" onClick={(e) => e.stopPropagation()}>
                                            <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                                <User className="text-emerald-500/50 group-focus-within:text-emerald-400 transition-colors" size={24} />
                                            </div>
                                            <input
                                                ref={inputRef}
                                                type="text"
                                                value={nameInput}
                                                onFocus={() => setShowSuggestions(true)}
                                                onKeyDown={handleInputKeyDown}
                                                onChange={(e) => {
                                                    setNameInput(e.target.value);
                                                    setShowSuggestions(true);
                                                }}
                                                placeholder="បញ្ចូលឈ្មោះបុគ្គលិក..."
                                                className="w-full pl-14 pr-32 py-5 rounded-2xl glass-input text-lg font-medium text-white placeholder:text-slate-500 focus:bg-black/40 focus:border-emerald-500/50 focus:ring-4 focus:ring-emerald-500/10 outline-none transition-all duration-300"
                                                autoComplete="off"
                                            />
                                            <button 
                                                type="submit" 
                                                className="absolute right-2 top-2 bottom-2 bg-emerald-600 hover:bg-emerald-500 text-white px-6 rounded-xl font-bold shadow-[0_0_20px_rgba(16,185,129,0.2)] hover:shadow-[0_0_25px_rgba(16,185,129,0.4)] transform active:scale-95 transition-all duration-200 flex items-center gap-2 border border-emerald-400/20"
                                            >
                                                <Plus size={20} />
                                                <span className="hidden sm:inline">Add</span>
                                            </button>

                                            {/* Smart Suggestions Dropdown - Positioned ABOVE cards (z-50) */}
                                            {showSuggestions && suggestions.length > 0 && (
                                                <div className="absolute top-full left-0 right-0 mt-2 bg-[#0a201a] border border-emerald-500/30 rounded-2xl shadow-2xl overflow-hidden z-50 animate-slide-in max-h-60 overflow-y-auto custom-scrollbar">
                                                    <div className="px-4 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider bg-black/20 border-b border-white/5">
                                                        ជ្រើសរើសឈ្មោះ (បានកត់ត្រាថ្ងៃនេះ: {suggestions.filter(s => s.isToday).length})
                                                    </div>
                                                    {suggestions.map((suggestion, index) => (
                                                        <div 
                                                            key={index}
                                                            onClick={() => selectSuggestion(suggestion.name)}
                                                            className={`px-4 py-3 cursor-pointer flex items-center justify-between group transition-colors border-b border-white/5 last:border-0 ${index === selectedIndex ? 'bg-emerald-500/30' : 'hover:bg-emerald-500/20'}`}
                                                        >
                                                            <div className="flex items-center gap-3">
                                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${suggestion.isToday ? 'bg-emerald-500 text-black' : 'bg-slate-700 text-slate-300'}`}>
                                                                    {suggestion.name.charAt(0).toUpperCase()}
                                                                </div>
                                                                <div>
                                                                    <div className="font-bold text-slate-200 group-hover:text-white">{suggestion.name}</div>
                                                                    {suggestion.isToday && (
                                                                        <div className="text-[10px] text-emerald-400 flex items-center gap-1">
                                                                            <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                                                                            ធ្លាប់សម្រាកថ្ងៃនេះ
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            
                                                            {suggestion.isToday && (
                                                                <div className="text-right">
                                                                    <div className="text-xs font-bold text-emerald-300 bg-emerald-500/10 px-2 py-0.5 rounded border border-emerald-500/20">
                                                                        {suggestion.count} ដង
                                                                    </div>
                                                                    <div className="text-[10px] text-slate-400 mt-0.5">
                                                                        សរុប: {formatTotalMinutes(suggestion.totalDuration)}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </form>
                                    </div>
                                </div>

                                {/* Active Breaks Section - Main UI (Limited to 6) */}
                                <div>
                                    <div className="flex items-center justify-between mb-6 px-2">
                                        <h3 className="text-lg font-bold text-emerald-100 flex items-center gap-2">
                                            <Timer size={20} className="text-emerald-400" />
                                            កំពុងសម្រាក (Live)
                                            <span className="bg-emerald-500/20 text-emerald-300 text-xs py-0.5 px-2 rounded-full ml-1 font-extrabold border border-emerald-500/20">
                                                {activeBreaks.length}
                                            </span>
                                        </h3>
                                        <div className="flex items-center gap-2">
                                            {activeBreaks.length > 6 && (
                                                <button 
                                                    onClick={() => setShowFullActiveList(true)}
                                                    className="text-xs font-bold bg-white/10 hover:bg-white/20 text-emerald-300 px-3 py-1 rounded-lg transition"
                                                >
                                                    បង្ហាញទាំងអស់ (Alt+1)
                                                </button>
                                            )}
                                            {syncStatus === 'syncing' && <span className="text-xs text-emerald-500/70 animate-pulse">Updating...</span>}
                                        </div>
                                    </div>
                                    
                                    {activeBreaks.length === 0 ? (
                                        <div className="glass-panel border-dashed border-emerald-500/20 rounded-3xl p-12 flex flex-col items-center justify-center text-center">
                                            <div className="bg-emerald-500/5 p-4 rounded-full mb-4 border border-emerald-500/10">
                                                <Coffee size={40} className="text-emerald-500/30" />
                                            </div>
                                            <p className="text-emerald-100/50 font-medium text-lg">មិនមានបុគ្គលិកកំពុងសម្រាកទេ</p>
                                            <p className="text-emerald-500/30 text-sm mt-1">ទិន្នន័យពី Google Sheet នឹងបង្ហាញទីនេះ</p>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {activeBreaks.slice(0, 6).map((item) => {
                                                const durationInfo = calculateLiveDurationInfo(item.startTime);
                                                const isOvertime = durationInfo.minutes > 15;
                                                
                                                return (
                                                    <div 
                                                        key={item.id} 
                                                        onClick={() => handleEndBreak(item)}
                                                        className={`glass-panel p-5 rounded-2xl hover:bg-emerald-900/20 hover:border-emerald-400 transition-all duration-300 animate-slide-in relative overflow-hidden group border-l-4 border-l-emerald-500 clickable-card ${isOvertime ? 'overtime-alert' : ''}`}
                                                    >
                                                        <div className="flex justify-between items-start">
                                                            <div className="pl-2">
                                                                <h4 className="font-bold text-xl text-white mb-1">{item.name}</h4>
                                                                <div className="flex items-center gap-2 text-emerald-400/70 text-sm mb-4">
                                                                    <Clock size={14} className="text-emerald-500"/>
                                                                    <span>ចាប់ផ្តើម: {formatTime(item.startTime)}</span>
                                                                </div>
                                                                
                                                                <div className={`px-3 py-1.5 rounded-lg inline-flex items-center gap-2 font-mono font-bold text-lg border shadow-inner ${isOvertime ? 'bg-red-900/40 text-red-400 border-red-500/50' : 'bg-black/30 text-emerald-400 border-emerald-500/20'}`}>
                                                                    <span className={`relative flex h-2 w-2 ${isOvertime ? 'hidden' : ''}`}>
                                                                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                                                        <span className="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                                                    </span>
                                                                    {durationInfo.text}
                                                                </div>
                                                                
                                                                {isOvertime && (
                                                                    <div className="text-xs font-bold text-red-500 mt-2 animate-pulse flex items-center gap-1">
                                                                        <AlertTriangle size={12} />
                                                                        លើស {durationInfo.minutes - 15} នាទី
                                                                    </div>
                                                                )}
                                                            </div>

                                                            <button
                                                                className="bg-emerald-500/10 text-emerald-300 p-4 rounded-2xl hover:bg-emerald-500 hover:text-white hover:shadow-[0_0_20px_rgba(16,185,129,0.4)] transition-all duration-300 group-hover:scale-105 active:scale-95 flex flex-col items-center gap-1 border border-emerald-500/20"
                                                                title="ត្រឡប់ចូលធ្វើការ"
                                                                onClick={(e) => {
                                                                    e.stopPropagation(); // Keep button separate if needed logic later, but div click handles it too
                                                                    handleEndBreak(item);
                                                                }}
                                                            >
                                                                <LogIn size={24} />
                                                                <span className="text-[10px] font-bold uppercase tracking-wide">ចូលវិញ</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Right Panel: History */}
                            <div className="lg:col-span-4">
                                <div className="glass-panel rounded-3xl flex flex-col h-[calc(100vh-8rem)] sticky top-24 overflow-hidden">
                                    <div className="p-6 border-b border-emerald-500/10 bg-black/20 flex justify-between items-center">
                                        <h3 className="font-bold text-lg text-emerald-100 flex items-center gap-2">
                                            <History className="text-emerald-400" size={20} />
                                            <span>ប្រវត្តិថ្ងៃនេះ</span>
                                        </h3>
                                        {records.length > 0 && (
                                            <div className="text-xs text-slate-500">Sync with Sheet</div>
                                        )}
                                    </div>
                                    
                                    <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                                        {records.length === 0 ? (
                                            <div className="h-full flex flex-col items-center justify-center text-emerald-500/20 space-y-3">
                                                <Calendar size={48} strokeWidth={1} />
                                                <p className="text-sm font-mono">NO_DATA_AVAILABLE</p>
                                            </div>
                                        ) : (
                                            records.map((record) => (
                                                <div 
                                                    key={record.id} 
                                                    className="bg-black/20 border border-emerald-500/10 p-4 rounded-2xl hover:border-emerald-500/30 hover:bg-emerald-500/5 transition-all duration-200 animate-slide-in group relative"
                                                >
                                                    <button 
                                                        onClick={() => handleDeleteRecord(record.id)}
                                                        className="absolute top-2 right-2 text-slate-600 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                    >
                                                        <Trash2 size={14} />
                                                    </button>

                                                    <div className="flex justify-between items-start mb-2 pr-4">
                                                        <span className="font-bold text-slate-200 text-lg group-hover:text-emerald-400 transition-colors">
                                                            {record.name}
                                                        </span>
                                                        <span className="bg-emerald-500/10 text-emerald-400 text-xs font-bold px-2 py-1 rounded-lg border border-emerald-500/10">
                                                            {formatTotalMinutes(record.durationMinutes || record.duration)}
                                                        </span>
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-2 gap-2 text-xs text-slate-400 mt-3">
                                                        <div className="bg-black/30 p-2 rounded-lg flex items-center gap-2 border border-white/5">
                                                            <LogOut size={12} className="text-orange-400" />
                                                            {formatTime(record.startTime)}
                                                        </div>
                                                        <div className="bg-emerald-900/20 p-2 rounded-lg flex items-center gap-2 text-emerald-300 border border-emerald-500/10">
                                                            <LogIn size={12} className="text-emerald-400" />
                                                            {formatTime(record.endTime)}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                    
                                    <div className="p-4 bg-black/20 border-t border-emerald-500/10 text-center">
                                        <p className="text-xs font-medium text-emerald-500/50 uppercase tracking-widest font-mono">
                                            Total Records: {records.length}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            </div>
                        </main>
                    </div>

                    {/* MOBILE UI (Hidden on desktop) */}
                    <div className="md:hidden flex flex-col h-screen overflow-hidden">
                        {/* Mobile Header - Fixed Top */}
                        <div className="flex-none p-4 glass-panel border-b border-emerald-500/10 flex items-center justify-between z-40">
                             <div className="flex items-center gap-2">
                                <div className="bg-emerald-500/20 p-1.5 rounded-lg text-emerald-400">
                                    <Zap size={18} />
                                </div>
                                <h1 className="text-lg font-bold text-white tracking-wider neon-text">
                                    BIO<span className="text-emerald-400">BREAK</span>
                                </h1>
                            </div>
                            <div className="flex items-center gap-2">
                                {syncStatus === 'syncing' && <div className="spinner w-4 h-4"></div>}
                                <button onClick={() => setShowSettings(true)} className="p-1.5 text-slate-400 bg-white/5 rounded-lg">
                                    <Settings size={18} />
                                </button>
                            </div>
                        </div>

                        {/* Mobile Content Area - Scrollable */}
                        <div className="flex-1 overflow-y-auto pb-24 p-4 custom-scrollbar">
                            
                            {/* ACTIVE TAB CONTENT */}
                            {mobileTab === 'active' && (
                                <div className="space-y-6">
                                    {/* Sticky Input for Mobile */}
                                    <div className="sticky top-0 z-30 -mx-2 px-2 pb-2 pt-1 bg-[#051a14]/95 backdrop-blur-sm">
                                        <div className="glass-panel p-4 rounded-2xl relative">
                                            <form onSubmit={handleStartBreak} className="relative">
                                                <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                                                    <User className="text-emerald-500/50" size={20} />
                                                </div>
                                                <input
                                                    type="text"
                                                    value={nameInput}
                                                    onFocus={() => setShowSuggestions(true)}
                                                    onChange={(e) => {
                                                        setNameInput(e.target.value);
                                                        setShowSuggestions(true);
                                                    }}
                                                    placeholder="បញ្ចូលឈ្មោះ..."
                                                    className="w-full pl-10 pr-12 py-3 rounded-xl glass-input text-base text-white placeholder:text-slate-500 focus:bg-black/60 outline-none"
                                                />
                                                <button 
                                                    type="submit" 
                                                    className="absolute right-1 top-1 bottom-1 bg-emerald-600 text-white px-3 rounded-lg shadow-lg flex items-center justify-center"
                                                >
                                                    <Plus size={20} />
                                                </button>

                                                {/* Suggestions Mobile */}
                                                {showSuggestions && suggestions.length > 0 && (
                                                    <div className="absolute top-full left-0 right-0 mt-2 bg-[#0a201a] border border-emerald-500/30 rounded-xl shadow-2xl overflow-hidden z-50 max-h-48 overflow-y-auto custom-scrollbar">
                                                        {suggestions.map((suggestion, index) => (
                                                            <div 
                                                                key={index}
                                                                onClick={() => {
                                                                    selectSuggestion(suggestion.name);
                                                                    setShowSuggestions(false);
                                                                }}
                                                                className="px-4 py-3 border-b border-white/5 last:border-0 flex items-center justify-between active:bg-emerald-500/20"
                                                            >
                                                                <span className="text-white font-medium">{suggestion.name}</span>
                                                                {suggestion.isToday && <span className="text-xs text-emerald-400 bg-emerald-500/10 px-1.5 py-0.5 rounded">{suggestion.count}ដង</span>}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </form>
                                        </div>
                                    </div>

                                    {/* Mobile Active List */}
                                    <div className="space-y-3">
                                        <h3 className="text-sm font-bold text-emerald-400 uppercase tracking-widest flex items-center gap-2">
                                            កំពុងសម្រាក <span className="bg-emerald-500/20 px-2 rounded-full text-white">{activeBreaks.length}</span>
                                        </h3>
                                        
                                        {activeBreaks.length === 0 ? (
                                            <div className="text-center py-10 text-slate-500 text-sm">
                                                មិនមានអ្នកសម្រាកទេ
                                            </div>
                                        ) : (
                                            activeBreaks.map((item) => {
                                                const durationInfo = calculateLiveDurationInfo(item.startTime);
                                                const isOvertime = durationInfo.minutes > 15;
                                                return (
                                                    <div 
                                                        key={item.id}
                                                        onClick={() => handleEndBreak(item)}
                                                        className={`bg-black/40 border p-4 rounded-2xl active:scale-98 transition-transform ${isOvertime ? 'border-red-500/50 bg-red-900/10' : 'border-emerald-500/20'}`}
                                                    >
                                                        <div className="flex justify-between items-center mb-2">
                                                            <span className="font-bold text-lg text-white">{item.name}</span>
                                                            <span className={`font-mono font-bold text-lg ${isOvertime ? 'text-red-400' : 'text-emerald-400'}`}>
                                                                {durationInfo.text}
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between items-center text-xs text-slate-400">
                                                            <div className="flex items-center gap-1">
                                                                <Clock size={12} /> {formatTime(item.startTime)}
                                                            </div>
                                                            <div className="flex items-center gap-1 text-emerald-500">
                                                                ចុចដើម្បីចូល <LogIn size={12} />
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* HISTORY TAB CONTENT */}
                            {mobileTab === 'history' && (
                                <div className="space-y-4">
                                     <h3 className="text-sm font-bold text-emerald-400 uppercase tracking-widest flex items-center gap-2 sticky top-0 bg-[#051a14] py-2 z-20">
                                        ប្រវត្តិថ្ងៃនេះ <span className="bg-emerald-500/20 px-2 rounded-full text-white">{records.length}</span>
                                    </h3>
                                    
                                    {records.length === 0 ? (
                                        <div className="text-center py-10 text-slate-500 text-sm">
                                            មិនទាន់មានប្រវត្តិ
                                        </div>
                                    ) : (
                                        records.map((record) => (
                                            <div 
                                                key={record.id} 
                                                className="bg-black/20 border border-emerald-500/10 p-4 rounded-2xl relative"
                                            >
                                                <button 
                                                    onClick={() => handleDeleteRecord(record.id)}
                                                    className="absolute top-3 right-3 text-slate-600 active:text-rose-500"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                                
                                                <div className="font-bold text-white mb-1">{record.name}</div>
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span className="text-xs bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/10">
                                                        {formatTotalMinutes(record.durationMinutes || record.duration)}
                                                    </span>
                                                </div>
                                                
                                                <div className="flex items-center justify-between text-xs text-slate-500 border-t border-white/5 pt-2 mt-2">
                                                    <span className="flex items-center gap-1"><LogOut size={10} className="text-orange-400"/> {formatTime(record.startTime)}</span>
                                                    <span className="flex items-center gap-1"><LogIn size={10} className="text-emerald-400"/> {formatTime(record.endTime)}</span>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}

                        </div>

                        {/* Mobile Footer Navigation - Fixed Bottom */}
                        <div className="flex-none glass-panel border-t border-emerald-500/20 pb-safe pt-2 px-6 flex justify-around items-center z-50">
                            <button 
                                onClick={() => setMobileTab('active')}
                                className={`flex flex-col items-center gap-1 p-2 w-16 transition-colors ${mobileTab === 'active' ? 'mobile-tab-active' : 'mobile-tab-inactive'}`}
                            >
                                <Coffee size={24} strokeWidth={mobileTab === 'active' ? 2.5 : 2} />
                                <span className="text-[10px] font-bold">សកម្មភាព</span>
                            </button>
                            
                            <button 
                                onClick={() => setMobileTab('history')}
                                className={`flex flex-col items-center gap-1 p-2 w-16 transition-colors ${mobileTab === 'history' ? 'mobile-tab-active' : 'mobile-tab-inactive'}`}
                            >
                                <History size={24} strokeWidth={mobileTab === 'history' ? 2.5 : 2} />
                                <span className="text-[10px] font-bold">ប្រវត្តិ</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
